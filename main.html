<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enigmatic World</title>
    <link href="style.css" rel="stylesheet" />
</head>
<body>
    <main class="game-container">
        <audio id="backgroundMusic" loop>
            <source src="assets/music_theme.mp3" type="audio/mpeg">
            Seu navegador n√£o suporta o elemento de √°udio.
        </audio>

        <iframe id="gameFrame" src="index.html" style="width: 100%; height: 100%; border: none; background-color: white;"></iframe>
    </main>

    <button id="toggleMusicBtn" class="music-toggle-button">üé∂ M√∫sica: Ligar</button>

    <script>
        const backgroundMusic = document.getElementById("backgroundMusic");
        const toggleMusicBtn = document.getElementById("toggleMusicBtn");
        const gameFrame = document.getElementById("gameFrame");

        // Carrega a prefer√™ncia de m√∫sica do localStorage
        let isMusicPlaying = localStorage.getItem("isMusicPlaying") === "true"; 
        
        // Define o texto inicial do bot√£o com base na prefer√™ncia carregada
        toggleMusicBtn.textContent = isMusicPlaying ? "üé∂ M√∫sica: Desligar" : "üé∂ M√∫sica: Ligar";

        // Tenta tocar a m√∫sica se o usu√°rio deixou ligada da √∫ltima vez
        // Usa .catch para capturar o erro de autoplay bloqueado
        if (isMusicPlaying) {
            backgroundMusic.volume = 0.4;
            backgroundMusic.play().catch(e => {
                console.warn("Autoplay de m√∫sica bloqueado pelo navegador:", e);
                // Define isMusicPlaying como false se o autoplay for bloqueado para refletir o estado real
                isMusicPlaying = false;
                localStorage.setItem("isMusicPlaying", isMusicPlaying);
                toggleMusicBtn.textContent = "üé∂ M√∫sica: Ligar";
                // alert("O navegador bloqueou a reprodu√ß√£o autom√°tica da m√∫sica. Por favor, clique no bot√£o para lig√°-la.");
            });
        }

        // Adiciona o evento de clique ao bot√£o de toggle
        toggleMusicBtn.addEventListener("click", () => {
            if (backgroundMusic.paused) {
                backgroundMusic.volume = 0.4;
                backgroundMusic.play().then(() => {
                    isMusicPlaying = true;
                    toggleMusicBtn.textContent = "üé∂ M√∫sica: Desligar";
                }).catch(e => {
                    console.error("Erro ao tentar tocar m√∫sica:", e);
                    // Aqui, voc√™ pode optar por notificar o usu√°rio que a m√∫sica n√£o p√¥de ser tocada
                    // alert("N√£o foi poss√≠vel tocar a m√∫sica. Tente novamente ou verifique as configura√ß√µes do navegador.");
                });
            } else {
                backgroundMusic.pause();
                isMusicPlaying = false;
                toggleMusicBtn.textContent = "üé∂ M√∫sica: Ligar";
            }
            localStorage.setItem("isMusicPlaying", isMusicPlaying);
        });

        // Este listener agora escuta mensagens do iframe filho (faseX.js e fase-final.js)
        window.addEventListener('message', (event) => {
            // Garante que a mensagem vem do iframe esperado e tem o formato correto
            if (event.source === gameFrame.contentWindow && event.data && event.data.type === 'toggleMusic') {
                // Simula um clique no bot√£o de m√∫sica
                toggleMusicBtn.click(); 
            }
            // Adicione mais verifica√ß√µes se voc√™ enviar outros tipos de mensagens
        });

        // Listener para garantir que, se o iframe muda de src, as prefer√™ncias de m√∫sica s√£o passadas
        gameFrame.addEventListener('load', () => {
            if (gameFrame.contentWindow) {
                gameFrame.contentWindow.postMessage({
                    type: 'musicState',
                    isPlaying: isMusicPlaying
                }, '*'); // Envia o estado atual da m√∫sica para o iframe rec√©m-carregado
            }
        });

        // Dispara o evento de carregamento para o estado inicial, caso o iframe j√° esteja carregado.
        // Isso √© √∫til se o iframe for carregado antes que este script termine.
        if (gameFrame.contentWindow && gameFrame.contentWindow.document.readyState === 'complete') {
            gameFrame.contentWindow.postMessage({
                type: 'musicState',
                isPlaying: isMusicPlaying
            }, '*');
        }

    </script>
</body>
</html>
