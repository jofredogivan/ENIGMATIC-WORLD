<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enigmatic World</title>
    <link href="style.css" rel="stylesheet" />
</head>
<body>
    <div class="game-wrapper"> <div class="game-container">
            <audio id="backgroundMusic" loop>
                <source src="assets/music_theme.mp3" type="audio/mpeg">
                Seu navegador n√£o suporta o elemento de √°udio.
            </audio>

            <iframe id="gameFrame" src="index.html" style="width: 100%; height: 100%; border: none; background-color: white;"></iframe>
        </div>

        <button id="toggleMusicBtn" class="music-toggle-button">üé∂ M√∫sica: Ligar</button>
    </div>

    <script>
        const backgroundMusic = document.getElementById("backgroundMusic");
        const toggleMusicBtn = document.getElementById("toggleMusicBtn");
        const gameFrame = document.getElementById("gameFrame");

        let isMusicPlaying = localStorage.getItem("isMusicPlaying") === "true"; 
        
        toggleMusicBtn.textContent = isMusicPlaying ? "üé∂ M√∫sica: Desligar" : "üé∂ M√∫sica: Ligar";

        if (isMusicPlaying) {
            backgroundMusic.volume = 0.4;
            backgroundMusic.play().catch(e => {
                console.warn("Autoplay de m√∫sica bloqueado pelo navegador:", e);
                isMusicPlaying = false; // Ajusta o estado se o autoplay falhar
                localStorage.setItem("isMusicPlaying", isMusicPlaying);
                toggleMusicBtn.textContent = "üé∂ M√∫sica: Ligar";
            });
        }

        toggleMusicBtn.addEventListener("click", () => {
            if (backgroundMusic.paused) {
                backgroundMusic.volume = 0.4;
                backgroundMusic.play().then(() => {
                    isMusicPlaying = true;
                    toggleMusicBtn.textContent = "üé∂ M√∫sica: Desligar";
                }).catch(e => {
                    console.error("Erro ao tentar tocar m√∫sica via bot√£o:", e);
                    alert("N√£o foi poss√≠vel tocar a m√∫sica. O navegador pode ter bloqueado a reprodu√ß√£o autom√°tica.");
                });
            } else {
                backgroundMusic.pause();
                isMusicPlaying = false;
                toggleMusicBtn.textContent = "üé∂ M√∫sica: Ligar";
            }
            localStorage.setItem("isMusicPlaying", isMusicPlaying);
        });

        // Listener para receber mensagens do iframe filho (faseX.js e fase-final.js)
        window.addEventListener('message', (event) => {
            if (event.source === gameFrame.contentWindow && event.data && event.data.type === 'toggleMusic') {
                toggleMusicBtn.click(); // Simula um clique no bot√£o de m√∫sica
            }
        });
        
        // Quando o iframe recarrega (ex: navegando para uma nova fase)
        gameFrame.addEventListener('load', () => {
            if (gameFrame.contentWindow) {
                // Envia o estado atual da m√∫sica para o iframe rec√©m-carregado
                gameFrame.contentWindow.postMessage({
                    type: 'musicState',
                    isPlaying: isMusicPlaying
                }, '*'); 
            }
        });

        // Dispara o evento de carregamento para o estado inicial, caso o iframe j√° esteja carregado.
        if (gameFrame.contentWindow && gameFrame.contentWindow.document.readyState === 'complete') {
            gameFrame.contentWindow.postMessage({
                type: 'musicState',
                isPlaying: isMusicPlaying
            }, '*');
        }
    </script>
</body>
</html>
