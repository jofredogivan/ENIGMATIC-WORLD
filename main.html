<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enigmatic World</title>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+DW+Pica:ital@0;1&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <link href="style.css" rel="stylesheet" />
</head>
<body>
    <div class="app-container">
        <audio id="backgroundMusic" loop>
            <source src="assets/music_theme.mp3" type="audio/mpeg">
            Seu navegador nÃ£o suporta o elemento de Ã¡udio.
        </audio>

        <iframe id="gameFrame" src="index.html" style="width: 100%; height: 100%; border: none; background-color: transparent;"></iframe>
        <button id="toggleMusicBtn" class="music-toggle-button">ðŸŽ¶ MÃºsica: Ligar</button>
    </div>

    <script>
        const backgroundMusic = document.getElementById("backgroundMusic");
        const toggleMusicBtn = document.getElementById("toggleMusicBtn");
        const gameFrame = document.getElementById("gameFrame");

        // Logs de depuraÃ§Ã£o (manter para garantir que os elementos sÃ£o encontrados)
        console.log("backgroundMusic element:", backgroundMusic);
        console.log("toggleMusicBtn element:", toggleMusicBtn); // Verifica se o botÃ£o foi encontrado no DOM

        let isMusicPlaying = localStorage.getItem("isMusicPlaying") === "true"; 
        
        // Define o texto inicial do botÃ£o, verificando se o botÃ£o existe
        if (toggleMusicBtn) { 
            toggleMusicBtn.textContent = isMusicPlaying ? "ðŸŽ¶ MÃºsica: Desligar" : "ðŸŽ¶ MÃºsica: Ligar";
        }

        // Tenta tocar a mÃºsica se o usuÃ¡rio deixou ligada da Ãºltima vez
        if (isMusicPlaying) {
            if (backgroundMusic) { 
                backgroundMusic.volume = 0.4;
                backgroundMusic.play().catch(e => {
                    console.warn("Autoplay de mÃºsica bloqueado pelo navegador:", e);
                    isMusicPlaying = false; 
                    localStorage.setItem("isMusicPlaying", isMusicPlaying);
                    if (toggleMusicBtn) { toggleMusicBtn.textContent = "ðŸŽ¶ MÃºsica: Ligar"; }
                });
            } else {
                console.error("Elemento de Ã¡udio backgroundMusic nÃ£o encontrado!");
            }
        }

        // Adiciona o evento de clique ao botÃ£o de toggle
        if (toggleMusicBtn) { 
            toggleMusicBtn.addEventListener("click", () => {
                console.log("BotÃ£o de mÃºsica clicado!"); // Para depuraÃ§Ã£o
                if (backgroundMusic && backgroundMusic.paused) {
                    backgroundMusic.volume = 0.4;
                    backgroundMusic.play().then(() => {
                        isMusicPlaying = true;
                        toggleMusicBtn.textContent = "ðŸŽ¶ MÃºsica: Desligar";
                    }).catch(e => {
                        console.error("Erro ao tentar tocar mÃºsica:", e);
                        alert("NÃ£o foi possÃ­vel tocar a mÃºsica. O navegador pode ter bloqueado a reproduÃ§Ã£o automÃ¡tica.");
                    });
                } else if (backgroundMusic) {
                    backgroundMusic.pause();
                    isMusicPlaying = false;
                    toggleMusicBtn.textContent = "ðŸŽ¶ MÃºsica: Ligar";
                }
                localStorage.setItem("isMusicPlaying", isMusicPlaying);
            });
        } else {
            console.error("BotÃ£o de mÃºsica nÃ£o encontrado no DOM! Verifique o ID e o carregamento do script.");
        }

        // Listener para receber mensagens do iframe filho (faseX.js e fase-final.js)
        window.addEventListener('message', (event) => {
            if (event.source === gameFrame.contentWindow && event.data && event.data.type === 'toggleMusic') {
                if (toggleMusicBtn) { toggleMusicBtn.click(); }
            }
        });
        
        // Quando o iframe recarrega (ex: navegando para uma nova fase)
        gameFrame.addEventListener('load', () => {
            if (gameFrame.contentWindow) {
                gameFrame.contentWindow.postMessage({
                    type: 'musicState',
                    isPlaying: isMusicPlaying
                }, '*'); 
            }
        });

        // Dispara o evento de carregamento para o estado inicial, caso o iframe jÃ¡ esteja carregado.
        if (gameFrame.contentWindow && gameFrame.contentWindow.document.readyState === 'complete') {
            gameFrame.contentWindow.postMessage({
                type: 'musicState',
                isPlaying: isMusicPlaying
            }, '*');
        }
    </script>
</body>
</html>
